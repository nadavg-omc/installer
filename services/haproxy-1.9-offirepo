#!/bin/bash

# Add this at the begining of all scripts.
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

checkTagExist ssl-ready.success

rootDir=$(rootDir)
domainName="${CWM_SERVERIP//./-}.cloud-xip.io"
certsPath=/etc/letsencrypt/live/${domainName}
certsArchivePath=/etc/letsencrypt/archive/${domainName}
certsUpdateService=/opt/update-certs.sh
certGeneratedName="haproxy-fullcert.pem"

echo "Installing dependencies" | log
apt install software-properties-common -y | log
checkPackageInstalled software-properties-common

echo "Adding repository to OS package manager" | log
add-apt-repository ppa:vbernat/haproxy-1.9 -y
apt update

echo "Installing main application" | log
apt install haproxy=1.9.\* -y | log
checkPackageInstalled haproxy

echo "Open port for stats web ui" | log
ufw allow 8404

echo "Placing annotated config file" | log
backupFile /etc/haproxy/haproxy.cfg
cp -f $rootDir/tweaks/extras/haproxy/haproxy.cfg /etc/haproxy/
pass=$(echo ${ADMINPASSWORD//\&/\\&} | sed 's|[$#]|\\\\&|g')
sed -i '/stats auth/s/USERPASS_PLACEHOLDER/admin:"'$pass'"/g' /etc/haproxy/haproxy.cfg
sed -i 's|CERTS_PATH_PLACEHOLDER|'"${certsPath}"'|g' /etc/haproxy/haproxy.cfg
sed -i 's/CERT_GENERATED_NAME/'"${certGeneratedName}"'/g' /etc/haproxy/haproxy.cfg
service haproxy reload

cat << EOF > ${certsUpdateService}

certbot -q renew
cd ${certsArchivePath}
rm ${certGeneratedName}
cat `find "$(pwd)" -type f -name "*fullchain*"` `find "$(pwd)" -type f -name "*privk*"` > ${certGeneratedName}
cd ${certsPath}
ln -s haproxy-fullcert.pem ../../archive/${domainName}/${certGeneratedName}
service haproxy reload

EOF
chmod +x ${certsUpdateService}

backupFile /lib/systemd/system/certbot.service
# sed -i '\|ExecStart|s|=.*|=/bin/bash '"${certsUpdateService}"'|' /lib/systemd/system/certbot.service
sed -i '\|ExecStart|s|-q renew|-q renew --post-hook "/bin/bash '${certsUpdateService}'"|' /lib/systemd/system/certbot.service
systemctl daemon-reload

echo "Adding descriptions" | log
descriptionAppend "HAProxy Address: ${domainName}"
descriptionAppend " "
descriptionAppend "HAProxy Stats Web UI: https://${domainName}:8404/stats"
descriptionAppend "HAProxy Stats Web UI Username: admin"
descriptionAppend "HAProxy Stats Web UI Password: ${ADMINPASSWORD}"
descriptionAppend " "
descriptionAppend "HAProxy config file: /etc/haproxy/haproxy.cfg"
descriptionAppend " "
descriptionAppend "HAProxy examples: /usr/share/doc/haproxy/examples"
descriptionAppend "HAProxy documentation (on-server): /usr/share/doc/haproxy/"
descriptionAppend "HAProxy documentation (online): http://cbonte.github.io/haproxy-dconv/1.9/intro.html"
descriptionAppend " "


tagScript success

exit 0