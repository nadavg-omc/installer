#!/bin/bash


if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

rootDir=$(rootDir)
configFile=/etc/mongod.conf

echo "Adding repo to OS" | log
echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-4.0.list
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4
apt update -y

echo "Install mongodb from apt" | log
installPackage glibc-source mongodb-org | log
waitOrStop 0 "Failed apt install: mongodb-org"

echo "Enabling authorization" | log
sed -i "s/#security/security/g" $configFile
sed -i "/security:/ a \  authorization: enabled" $configFile

echo "Activating service" | log
systemctl enable mongod.service
systemctl start mongod.service 
sleep 5

echo "Adding admin user" | log
command="db.adminCommand({ createUser: \"admin\", pwd: \"$ADMINPASSWORD\", roles: [\"userAdminAnyDatabase\", \"dbAdminAnyDatabase\", \"readWriteAnyDatabase\"]});"
mongo --eval "${command}" | log

echo "Adding descriptions" | log
descriptionAppend "MongoDB Address: ${CWM_SERVERIP}"
descriptionAppend "MongoDB Username: admin"
descriptionAppend "MongoDB Password: ${ADMINPASSWORD}"
descriptionAppend " "
descriptionAppend "MongoDB config file: ${configFile}"
descriptionAppend " "

tag mongodb.success
tagScript success

exit 0
